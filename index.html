<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Air Crash since 1908</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">

</head>
<style>
    html{
        height: 100vh;
    }
    body {
        background: #f9f9f9;
    color: #333;
    font-family: 'Open Sans', sans-serif;
    }
    .mainHead{
 
        font-weight: bold;
        text-align: center;
        font-size: 2.5rem;
    }

    
    
    /*bar*/
    svg.bar{
        width: 100%;
        
    }
    .viz-1 .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }
    .viz-1 .bar {
            opacity: 1;

        }
        .viz-1 .grid line {
            stroke: gainsboro;
        }
        .viz-1 .grid path {
            stroke-width: 0;
        }
        .viz-1 .grid text {
            display: none;
        }

    /*pie css*/
    .pie {
        position: relative;
        top:5%;
        /*filter: drop-shadow(0 1px 3px #333);*/
    }
    .pie .data-path:hover {
        cursor: pointer;
    }
    .pie .data-text {
        transition: transform .2s ease-in-out;
        fill: #333;
    }
    .pie .data-text__value {
        font-size: 2rem;
        transform: translateY(-.5rem);
        opacity: 0;
    }
    .pie .data-text__name {
        font-size: 1rem;
        transform: translateY(.5rem);
        opacity: 0;
    }
    .pie .data-text--show {
        transform: translateY(0);
        animation: fadeGraphTextIn .5s forwards;
    }
    .pie .legend-text {
        fill: #333;
    }
    @keyframes fadeGraphTextIn {
        from {
            opacity: 0;
        }
        to {
            opacity: 1;
        }
    }

    /*geomap*/
    .viz-3 .tooltip {
            position: absolute;
            text-align: center;
            width: 120px;
            
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }
        .viz-3 .legend {
            font-family: sans-serif;
            font-size: 12px;
        }
        .viz-3 .legend rect {
            fill: 333;
            stroke: black;
            opacity: 0.8;
        }
        .viz-3 text {
            font-size: 8px;
            font-weight: bold;
            fill: #333;
            pointer-events: none;
        }
        .viz-3 .selected {
            stroke: rgb(255, 255, 255);
            stroke-width: 1px;
        }
        .viz-3 .legend-heading{
            font-size: 15px;
            color: 333;
        }


        /*tree node*/
        .treenode .node {
            border: solid 1px white;
            overflow: hidden;
            position: absolute;
            text-indent: 2px;
            transition: transform 0.5s ease;
        }
        .treenode .node:hover {
            transform: scale(1.05);
            z-index: 1;
        }
        .treenode text {
            pointer-events: none;
        }
      



</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<!--script src="script.js"></script-->
<body>
    <section id="header" class="mt-3">
	<div class="container">
		<div class="heading text-center"><h2 class="mainHead">Air Crash since 1908</h2></div>
	</div> 
</section>
    <section id="visual" class="mt-1">
        <div class="container-fluid">
        <div class="row">
            <div class="col-md-9 viz-1">
                <div class="tooltip"></div>
                <svg id="visualization1" height="380"></svg>
               
            </div>
            <div class="col-md-3">
                <svg id="visualization2" width="400" height="400"></svg>
            </div>
        </div>
        <div class="row pt-1">
            <div class="col-md-7 viz-3">
                <h5 align="center">Countries with most crashes map</h4>
                <svg id="visualization3" width="400" height="400"></svg>
            </div>
            <div class="col-md-5">
                <h5 align="center">Top 10 Aircraft with most crashes</h4>
                <svg id="visualization4" width="400" height="400"></svg>
            </div>
        </div>
        </div>

    </section>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
<script>
    let fullData;
    let x;
    let colorScale4 = d3.scaleSequential(d3.interpolateBlues);
    let treemapLayout = d3.treemap().size([680, 350]).padding(1);
    let barSvg;
    const labelMapping = {
        "Sum_of_Ground": "Sum of Ground",
        "Sum_of_Fatalities_air": "Sum of Fatalities air",
        "Sum_of_Aboard": "Sum of Aboard"
};
   // Define visualization functions
function visualization1(data) {
    // Code for visualization 1
    // Add your D3 code here
    const margin = { top: 20, right: 20, bottom: 30, left: 40 },
            barWidth = 1200 - margin.left - margin.right,
            barHeight = 350 - margin.top - margin.bottom;
           

        const barSvg = d3.select("#visualization1")
            .attr('class', 'bar')
            .append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        const tooltip = d3.select(".viz-1 .tooltip");
        //console.log(tooltip)
        let aggregatedData = {};
        data.forEach(d => {
            if (!aggregatedData[d.Year]) {
                aggregatedData[d.Year] = { Year: d.Year, Sum_of_Ground: 0, Sum_of_Fatalities_air: 0, Sum_of_Aboard: 0 };
            }
            aggregatedData[d.Year].Sum_of_Ground += +d.Sum_of_Ground;
            aggregatedData[d.Year].Sum_of_Fatalities_air += +d.Sum_of_Fatalities_air;
            aggregatedData[d.Year].Sum_of_Aboard += +d.Sum_of_Aboard;
        });

        let processedData = Object.values(aggregatedData);
        const subgroups = ["Sum_of_Ground", "Sum_of_Fatalities_air", "Sum_of_Aboard"];
        const color = d3.scaleOrdinal().domain(subgroups).range(['#18FFFF', '#0288D1', '#BF360C']);

        x = d3.scaleBand()
            .domain(processedData.map(d => d.Year))
            .range([0, barWidth])
            .padding(0.1);

            const xAxis = d3.axisBottom(x)
    .tickSizeOuter(0)
    .tickFormat((d, i) => i % 3 === 0 ? d : '');

    
            // Define the brush
    const brush = d3.brushX()
        .extent([[0, 0], [barWidth, barHeight]])
        .on("end", brushed);

    // Append the brush to the svg
    barSvg.append("g")
        .attr("class", "brush")
        .call(brush);


            barSvg.append("g")
            .attr("transform", `translate(0,${barHeight})`)
            .call(xAxis)
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "-.8em")
            .attr("dy", ".15em")
            .attr("transform", "rotate(-40)");

        const y = d3.scaleLinear()
            .domain([0, d3.max(processedData, d => +d.Sum_of_Ground + +d.Sum_of_Fatalities_air + +d.Sum_of_Aboard)])
            .range([barHeight, 0]);
        barSvg.append("g").call(d3.axisLeft(y).ticks(5));

        const stack = d3.stack()
            .keys(subgroups)
            .order(d3.stackOrderNone)
            .offset(d3.stackOffsetNone);

        const stackedData = stack(processedData);

        /*barSvg.append('g')
        .attr('class', 'grid')
        .call(d3.axisLeft(y).tickSize(-barWidth))*/
        barSvg.append("g")
            .attr("class", "grid")
            .call(d3.axisLeft(y)
                .tickSize(-barWidth)
                .tickFormat("")); // Empty tick format to remove tick labels

        const bars = barSvg.append("g")
            .selectAll("g")
            .data(stackedData)
            .enter().append("g")
              .attr("fill", d => color(d.key))
              .selectAll("rect")
              .data(d => d)
              .enter().append("rect")
                .attr("x", d => x(d.data.Year))
                .attr("width", x.bandwidth())
                .attr("y", d => y(d[1])) // Initial y position
                .attr("height", 0); // Initial height

        // Animation with transition
        bars.transition()
            .duration(1600) // Duration of the animation in milliseconds
            .attr("y", d => y(d[1])) // Final y position
            .attr("height", d => y(d[0]) - y(d[1])) // Final height
            .on("end", function() {
                // Add interactivity after transition finishes
                d3.select(this)
                  .on("mouseover", function(event, d) {
                      const key = d3.select(this.parentNode).datum().key;
                      const value = d.data[key];
                      const displayKey = labelMapping[key];
                      tooltip
                        .style("opacity", 1)
                        .html(`Year: ${d.data.Year}<br>${displayKey}: ${value}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 10) + "px");
                  })
                  .on("mouseout", function() {
                      tooltip.style("opacity", 0);
                  });
            });

         
}

function visualization2(data) {
   
    let totalGround = 0, totalFatalities = 0, totalAboard = 0;

    data.forEach(d => {
        totalGround += +d.Sum_of_Ground;
        totalFatalities += +d.Sum_of_Fatalities_air;
        totalAboard += +d.Sum_of_Aboard;
    });

    const pieData = [
        { name: 'Sum of Ground', value: totalGround, color: '#18FFFF' },
        { name: 'Sum of Fatalities air', value: totalFatalities, color: '#0288D1' },
        { name: 'Sum of Aboard', value: totalAboard, color: '#BF360C' }
    ];

    // Pie chart setup
    const viewWidth = 300,
          viewHeight = 300,
          svgWidth = viewHeight,
          svgHeight = viewHeight,
          thickness = 40,
          radius = Math.min(svgWidth, svgHeight) / 2,
          color = d3.scaleOrdinal()
                    .range(pieData.map(k => k.color));

    const svg = d3.select("#visualization2")
        
        .attr('viewBox', `0 0 ${viewWidth + thickness} ${viewHeight + thickness}`)
        .attr('class', 'pie')
        .attr('width', viewWidth)
        .attr('height', svgHeight);

    const g = svg.append('g')
        .attr('transform', `translate( ${ (svgWidth / 2) + (thickness / 2) }, ${ (svgHeight / 2) + (thickness / 2)})`);

    const arc = d3.arc()
        .innerRadius(radius - thickness)
        .outerRadius(radius);

    const pie = d3.pie()
        .value(function(pieData) { return pieData.value; })
        .sort(null);

    g.selectAll('path')
        .data(pie(pieData))
        .enter().append('path')
        .attr('d', arc)
        .attr('fill', d => color(d.data.name))
        .attr('class', 'data-path')
        .on('mouseover', function(event, d) {
                const path = d3.select(this);
                path.transition()
                    .duration(250)
                    .attr('d', d3.arc().innerRadius(radius - thickness).outerRadius(radius + 10));
                
                g.selectAll(".data-text__value, .data-text__name").remove();

                g.append('text')
                    .text(`${d.data.value.toLocaleString()}`)
                    .attr('class', 'data-text data-text__value data-text--show')
                    .attr('text-anchor', 'middle')
                    .attr('dy', '-1rem');

                g.append('text')
                    .text(`${d.data.name}`)
                    .attr('class', 'data-text data-text__name data-text--show')
                    .attr('text-anchor', 'middle')
                    .attr('dy', '1.5rem');
            })
            .on('mouseout', function() {
                d3.select(this).transition()
                    .duration(250)
                    .attr('d', arc);

                g.selectAll(".data-text__value, .data-text__name").remove();
            });

}


function visualization3(data) {
    const width = 930, height = 340;

    const svg = d3.select("#visualization3")
        .attr('class', 'geomap')
        .attr("width", width)
        .attr("height", height);

      

    const projection = d3.geoMercator()
        .scale(130)
        .center([0, 30])
        .translate([width / 2, height / 2]);

    const path = d3.geoPath().projection(projection);

    const crashCounts = new Map();
    data.forEach(d => {
        crashCounts.set(d['Country/Region'], (crashCounts.get(d['Country/Region']) || 0) + 1);
    });

    const colorScale = d3.scaleThreshold()
        .domain([1, 5, 10, 15, 20, 25, 30])
        .range(d3.schemeBlues[7]);

    const tooltip = d3.select(".viz-3").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    let centered;

    const zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on('zoom', (event) => {
            map.attr('transform', event.transform);
        });

    const map = svg.append('g')
        .call(zoom); // Apply the zoom behavior here


    // Legend
    const legendHeight = 300, legendWidth = 20, legendMargin = 10;
const legend = svg.append("g")
    .attr("id", "legend")
    .attr("transform", "translate(" + (width - 30 - legendMargin) + ",100)");

// Legend Heading
legend.append("text")
    .attr("class", "legend-heading")
    .attr("y", -10)
    .attr("x", -legendHeight / 2)
    .attr("transform", "rotate(-90)")
    .style("text-anchor", "middle")
    .text("Crashes");

// Note the domain here is reversed for the vertical legend to show larger values at the top
const legendScale = d3.scaleLinear()
    .domain([30, 0])
    .range([0, legendHeight]);

    legend.selectAll("rect")
    .data(colorScale.range().map(function(color) {
        var d = colorScale.invertExtent(color);
        if (d[0] == null) d[0] = legendScale.domain()[0];
        if (d[1] == null) d[1] = legendScale.domain()[1];
        return d;
    }))
    .enter().append("rect")
    .attr("width", legendWidth)
    .attr("y", function(d) { return legendScale(d[1]); }) // Use d[1] here for the y position
    .attr("height", function(d) { return legendScale(d[0]) - legendScale(d[1]); }) // Height calculated from the scale
    .attr("fill", function(d) { return colorScale(d[0]); });

legend.append("g")
    .attr("transform", "translate(" + legendWidth + ",20)")
    .call(d3.axisRight(legendScale)
        .tickSize(5)
        .tickValues(colorScale.domain()))
    .select(".domain")
    .remove();
    d3.json("https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson").then(function (topo) {

        const countries = map.selectAll("path")
            .data(topo.features)
            .join("path")
            // Draw each country
            .attr("d", path)
            // Set the color
            .attr("fill", function (d) {
                const crashes = crashCounts.get(d.properties.name) || 0;
                return colorScale(crashes);
            })
            // Add a class and a click event to each country
            .attr("class", "country")
            .on("click", clicked)
            .on("mouseover", function(event, d) {
                const crashes = crashCounts.get(d.properties.name) || 0;
                tooltip.transition()
                    .duration(200)
                    .style("opacity", .9);
                tooltip.html("Country: " + d.properties.name + "<br>Crashes: " + crashes)
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition()
                    .duration(500)
                    .style("opacity", 0);
            });

        map.selectAll("text")
            .data(topo.features)
            .enter().append("text")
            .attr("transform", function(d) { 
                return "translate(" + path.centroid(d) + ")"; 
            })
            .attr("dy", ".35em")
            .text(function(d) {
                const crashes = crashCounts.get(d.properties.name) || 0;
                return crashes > 0 ? crashes : '';
            });

        function clicked(event, d) {
            const country = d3.select(this);
            const isSelected = country.classed("selected");
            countries.classed("selected", false); // Remove selection from all countries
            country.classed("selected", !isSelected); // Toggle the selection

            const [[x0, y0], [x1, y1]] = path.bounds(d);
            event.stopPropagation();
            centered = centered !== d && !isSelected ? d : null;
            map.selectAll('.country').classed('active', centered && function(d) { return d === centered; });

            map.transition()
                .duration(750)
                .attr("transform", centered ? `translate(${width / 2},${height / 2})scale(4)translate(${-x0 - (x1 - x0) / 2},${-y0 - (y1 - y0) / 2})` : `translate(0,0)scale(1)`);
        }

        svg.on("click", () => {
            countries.classed("selected", false);
            if (centered) {
                map.transition()
                    .duration(750)
                    .attr("transform", `translate(0,0)scale(1)`);
                centered = null;
            }
        });
    }).catch(function (error) {
        console.error("Error loading GeoJSON: ", error);
    });
}

function visualization4(data) {

    updateVisualization4(data); 
    
   /* var groupedData = d3.rollup(data, v => v.length, d => d['Aircraft']);

          // Sort and take the top 10
            var sortedData = Array.from(groupedData).sort((a, b) => b[1] - a[1]).slice(0, 10);

            // Convert to hierarchy format
            var hierarchyData = {
                name: "Crashes",
                children: sortedData.map(d => ({name: d[0], value: d[1]}))
            };

            // Create a hierarchy
            var root = d3.hierarchy(hierarchyData)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);

            // Create treemap layout
            d3.treemap()
                .size([680, 350])
                .padding(1)(root);

            // Define a gradient color scale
            var color = d3.scaleSequential(d3.interpolateBlues)
                .domain([0, d3.max(sortedData, d => d[1])]);

            // Create SVG element
            const svg = d3.select("#visualization4")
                .attr('class', 'treenode')
                .attr("width", 680)
                .attr("height", 350);

            // Add rectangles for each node
            const nodes = svg.selectAll("g")
                .data(root.leaves())
                .enter()
                .append("g")
                .attr("transform", d => `translate(${d.x0},${d.y0})`);

            nodes.append("rect")
                .attr("width", d => d.x1 - d.x0)
                .attr("height", d => d.y1 - d.y0)
                .attr("fill", d => color(d.data.value))
                .on("mouseover", function(event, d) {
                    d3.select(this).style("opacity", 0.7);
                })
                .on("mouseout", function(event, d) {
                    d3.select(this).style("opacity", 1);
                });

            // Add text labels
            nodes.append("text")
                .attr("x", 5)
                .attr("y", 20)
                .text(d => d.data.name)
                .attr("font-size", "12px")
                .attr("fill", "white")
                .attr("word-break", "break-all");*/


}


function updateVisualization4(data) {
    // Process data
    var groupedData = d3.rollup(data, v => v.length, d => d['Aircraft']);
    var sortedData = Array.from(groupedData).sort((a, b) => b[1] - a[1]).slice(0, 10);
    //console.log("Sorted Data:", sortedData);
    var hierarchyData = { name: "Crashes", children: sortedData.map(d => ({ name: d[0], value: d[1] })) };
    var root = d3.hierarchy(hierarchyData).sum(d => d.value).sort((a, b) => b.value - a.value);
    d3.treemap().size([680, 350]).padding(1)(root);
    //console.log("Hierarchy Leaves:", root.leaves());

    // Apply the treemap layout
    //treemapLayout(root);

    // Set the color scale domain
    colorScale4.domain([0, d3.max(sortedData, d => d[1])]);

    // Select the SVG element for visualization 4 if it exists
    const svg = d3.select("#visualization4")
    .attr('class', 'treenode')
    .attr("width", 680)
    .attr("height", 350)
    .selectAll("g").data(root.leaves());

    // Enter new elements
    const nodesEnter = svg.enter().append("g")
    .attr("transform", d => `translate(${d.x0},${d.y0})`);
console.log("Nodes entering:", nodesEnter.size());

    nodesEnter.append("rect")
        .attr("width", d => d.x1 - d.x0)
        .attr("height", d => d.y1 - d.y0)
        .attr("fill", d => colorScale4(d.data.value));

    nodesEnter.append("text")
        .attr("x", 5)
        .attr("y", 20)
        .text(d => d.data.name)
        .attr("font-size", "12px")
        .attr("fill", "white");

    // Update existing elements
    svg.select("rect")
        .transition()
        .duration(500)
        .attr("width", d => d.x1 - d.x0)
        .attr("height", d => d.y1 - d.y0)
        .attr("fill", d => colorScale4(d.data.value));

    svg.select("text")
        .transition()
        .duration(500)
        .attr("x", 5)
        .attr("y", 20)
        .text(d => d.data.name);

    // Remove old elements
    svg.exit().remove();
}




function brushed(event) {

    if (event.selection) {
        const [x0, x1] = event.selection;
        const brushedYears = x.domain().filter(d => {
            const xValue = x(d) + x.bandwidth() / 2; // center of the bar
            return xValue >= x0 && xValue <= x1;
        });

        const filteredData = fullData.filter(d => brushedYears.includes(d.Year));
       // debugger
       console.log(filteredData)
        // Call functions to update other visualizations with filteredData
        document.getElementById("visualization2").innerHTML=""
        document.getElementById("visualization3").innerHTML=""
        document.getElementById("visualization4").innerHTML=""
        //console.log(document.getElementById("visualization1").innerHTML)
        updateVisualizations(filteredData);
    }
    else {
        // If the brush is cleared, use the full dataset
        document.getElementById("visualization2").innerHTML=""
        document.getElementById("visualization3").innerHTML=""
        document.getElementById("visualization4").innerHTML=""
        updateVisualizations(fullData);
    }
}

// Update all visualizations based on the brushed data or full data
function updateVisualizations(data) {
    visualization2(data); // Update visualization 2 with new data
    visualization3(data); // Update visualization 3 with new data
    updateVisualization4(data);//visualization4(data); // Update visualization 4 with new data
}

function clearSVG(){

}

// Load data and call visualization functions
d3.csv("dataset/aircrashFdata.csv").then(data => {
    fullData = data; // Store the loaded data
    visualization1(fullData); // Initialize visualization 1 with full data
    updateVisualizations(fullData); // Initialize other visualizations with full data
    //visualization1(data);
    //visualization2(data);
    // Call other visualization functions
    //visualization3(data);
    //visualization4(data);
}).catch(error => {
    console.error("Error loading the data: ", error);
});

    </script>
    </body>
</html>
